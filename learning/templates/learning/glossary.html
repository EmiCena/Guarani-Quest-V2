{% extends "base.html" %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/flashcards.css' %}">
  <meta name="description" content="Glosario interactivo de guaraní con pronunciación, categorías y seguimiento de progreso">
  <meta name="keywords" content="guaraní, glosario, aprendizaje, pronunciación, vocabulario">
{% endblock %}

{% block content %}
  <section style="text-align:center;margin:26px 0 10px;">
    <h1>📚 Glosario Guaraní Mejorado</h1>
    <p class="lead">Explora, escucha y graba pronunciaciones reales. Organiza tus palabras por categorías, dificultad y favoritos.</p>
  </section>

  <!-- Enhanced Controls -->
  <div style="max-width:1200px;margin:0 auto 20px;padding:0 20px;">
    <!-- Toolbar with advanced options -->
    <div class="glossary-toolbar">
      <!-- Search and Filters -->
      <div class="search-filters-section">
        <div class="search-bar">
          <input id="glossary-search" type="text" placeholder="🔍 Buscar en guaraní o español…"
                 oninput="qxFilterGlossary()" aria-label="Buscar palabras en el glosario"
                 style="flex:1;min-width:200px;">
          <button onclick="toggleAdvancedSearch()" class="qx-btn qx-outline btn-sm" id="advanced-search-btn"
                  aria-label="Búsqueda avanzada">⚙️</button>
        </div>

        <!-- Basic Filters -->
        <div class="basic-filters">
          <select id="category-filter" onchange="qxFilterGlossary()" aria-label="Filtrar por categoría">
            <option value="">📂 Todas las categorías</option>
            <option value="saludo">👋 Saludos</option>
            <option value="familia">👨‍👩‍👧‍👦 Familia</option>
            <option value="escuela">🏫 Escuela</option>
            <option value="comida">🍽️ Comida</option>
            <option value="lugares">📍 Lugares</option>
            <option value="numeros">🔢 Números</option>
            <option value="colores">🎨 Colores</option>
            <option value="general">📝 General</option>
          </select>

          <select id="difficulty-filter" onchange="qxFilterGlossary()" aria-label="Filtrar por dificultad">
            <option value="">⭐ Todas las dificultades</option>
            <option value="beginner">🟢 Principiante</option>
            <option value="intermediate">🟡 Intermedio</option>
            <option value="advanced">🔴 Avanzado</option>
          </select>

          <select id="mastery-filter" onchange="qxFilterGlossary()" aria-label="Filtrar por nivel de dominio">
            <option value="">🎯 Todos los niveles</option>
            <option value="new">🆕 Nuevas (0%)</option>
            <option value="learning">📚 Aprendiendo (1-49%)</option>
            <option value="practicing">✏️ Practicando (50-89%)</option>
            <option value="mastered">🎯 Dominadas (90-100%)</option>
          </select>

          <button onclick="toggleFavorites()" id="favorites-btn" class="qx-btn qx-outline" aria-label="Mostrar solo favoritos">
            ⭐ Favoritos
          </button>
        </div>

        <!-- Advanced Search Panel (initially hidden) -->
        <div id="advanced-search-panel" class="advanced-search-panel" style="display:none;">
          <div class="advanced-filters">
            <input type="checkbox" id="search-es-only" onchange="qxFilterGlossary()">
            <label for="search-es-only">Solo español</label>

            <input type="checkbox" id="search-gn-only" onchange="qxFilterGlossary()">
            <label for="search-gn-only">Solo guaraní</label>

            <input type="checkbox" id="search-exact-match" onchange="qxFilterGlossary()">
            <label for="search-exact-match">Búsqueda exacta</label>

            <select id="sort-order" onchange="sortGlossary()" aria-label="Ordenar por">
              <option value="recent">📅 Más recientes</option>
              <option value="alphabetical-es">🔤 A-Z (Español)</option>
              <option value="alphabetical-gn">🔤 A-Z (Guaraní)</option>
              <option value="mastery">🎯 Nivel de dominio</option>
              <option value="difficulty">⭐ Dificultad</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button onclick="startStudyMode()" class="qx-btn study-mode-btn" id="study-mode-btn" aria-label="Modo estudio">
          📚 Estudiar
        </button>
        <button onclick="exportGlossary()" class="qx-btn qx-outline" aria-label="Exportar glosario">
          📤 Exportar
        </button>
        <button onclick="importGlossary()" class="qx-btn qx-outline" aria-label="Importar glosario">
          📥 Importar
        </button>
        <button onclick="toggleDarkMode()" class="qx-btn qx-outline" id="dark-mode-btn" aria-label="Modo oscuro">
          🌙 Oscuro
        </button>
        <button onclick="showStats()" class="qx-btn qx-outline" aria-label="Ver estadísticas">
          📊 Stats
        </button>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-container">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">📊</div>
          <div class="stat-content">
            <div class="stat-number" id="total-words">0</div>
            <div class="stat-label">Total palabras</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">⭐</div>
          <div class="stat-content">
            <div class="stat-number" id="favorites-count">0</div>
            <div class="stat-label">Favoritos</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">✅</div>
          <div class="stat-content">
            <div class="stat-number" id="reviewed-count">0</div>
            <div class="stat-label">Revisadas</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">🎯</div>
          <div class="stat-content">
            <div class="stat-number" id="mastered-count">0</div>
            <div class="stat-label">Dominadas</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">📈</div>
          <div class="stat-content">
            <div class="stat-number" id="avg-mastery">0%</div>
            <div class="stat-label">Progreso promedio</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">🔥</div>
          <div class="stat-content">
            <div class="stat-number" id="study-streak">0</div>
            <div class="stat-label">Racha de estudio</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Overview -->
    <div class="progress-overview" id="progress-overview" style="display:none;">
      <h3>📈 Progreso de Aprendizaje</h3>
      <div class="progress-charts">
        <div class="chart-container">
          <canvas id="mastery-chart" width="300" height="200"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="category-chart" width="300" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div id="flash-grid" class="flash-grid">
    {% for e in entries %}
      <div class="flash enhanced-flash" tabindex="0"
           data-es="{{ e.source_text_es|lower }}"
           data-gn="{{ e.translated_text_gn|lower }}"
           data-category="{{ e.category|default:'general' }}"
           data-difficulty="{{ e.difficulty|default:'beginner' }}"
           data-favorite="{{ e.is_favorite|yesno:'true,false' }}"
           data-mastery="{{ e.mastery_level|default:0 }}">
        <div class="flash-inner">
          <!-- Frente: Guaraní -->
          <div class="face face-front">
            <!-- Enhanced header with category and difficulty -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <div class="category-badge" data-category="{{ e.category|default:'general' }}">
                {{ e.get_category_display|default:"General" }}
              </div>
              <div class="difficulty-badge difficulty-{{ e.difficulty|default:'beginner' }}">
                {{ e.get_difficulty_display|default:"Principiante" }}
              </div>
            </div>

            {% if e.is_favorite %}
              <div class="favorite-indicator">⭐</div>
            {% endif %}

            <div class="tag">Guaraní</div>
            <h3 class="word">{{ e.translated_text_gn }}</h3>

            <!-- Progress indicator -->
            {% if e.mastery_level > 0 %}
              <div class="mastery-indicator">
                <div class="mastery-bar">
                  <div class="mastery-fill" style="width:{{ e.mastery_level|floatformat:0 }}%"></div>
                </div>
                <span class="mastery-text">{{ e.mastery_level|floatformat:0 }}% dominada</span>
              </div>
            {% endif %}

            <div class="actions">
              {% if e.audio_pronunciation %}
                <audio id="audio-{{ e.id }}" src="{{ e.audio_pronunciation.url }}"></audio>
                <button class="qx-btn qx-outline btn-sm"
                        onclick="event.stopPropagation(); document.getElementById('audio-{{ e.id }}').play()">🔊 Reproducir</button>
              {% else %}
                <button class="qx-btn qx-outline btn-sm"
                        onclick="event.stopPropagation(); ttsSpeak('{{ e.translated_text_gn|escapejs }}','gn','suave')">🔊 TTS</button>
              {% endif %}

              <button class="qx-btn qx-outline btn-sm" onclick="toggleFavorite({{ e.id }})" title="Agregar a favoritos">
                {{ e.is_favorite|yesno:'⭐❤️,☆🤍' }}
              </button>
            </div>
          </div>

          <!-- Dorso: Español -->
          <div class="face face-back">
            <div class="tag">Español</div>
            <h3 class="word">{{ e.source_text_es }}</h3>
            {% if e.notes %}<div class="sub">“{{ e.notes }}”</div>{% endif %}

            <!-- Usage examples if available -->
            {% if e.usage_examples %}
              <div class="usage-examples">
                <strong>Ejemplos:</strong>
                <ul>
                  {% for example in e.usage_examples %}
                    <li>{{ example }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            <!-- Tags if available -->
            {% if e.tags %}
              <div class="tags-container">
                {% for tag in e.tags %}
                  <span class="tag-badge">{{ tag }}</span>
                {% endfor %}
              </div>
            {% endif %}

            <div class="rec-controls" id="rec-{{ e.id }}">
              <button class="qx-btn btn-sm" onclick="event.stopPropagation(); startRec({{ e.id }})">● Grabar</button>
              <button class="qx-btn qx-outline btn-sm" onclick="event.stopPropagation(); stopRec({{ e.id }})">■ Detener</button>
              <button class="qx-btn qx-outline btn-sm" onclick="event.stopPropagation(); saveRec({{ e.id }})">⬆ Guardar</button>
              <span class="hint" id="hint-{{ e.id }}"></span>
            </div>

            <div style="margin-top:8px;">
              <button class="qx-btn qx-outline btn-sm"
                      onclick="event.stopPropagation(); ttsSpeak('{{ e.source_text_es|escapejs }}','es','suave')">🔊 TTS (ES)</button>
            </div>

            <audio id="prev-{{ e.id }}" controls style="display:none;margin-top:8px;"></audio>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="card">
        <h3>📚 ¡Comienza tu glosario!</h3>
        <p>Aún no has agregado palabras. Puedes:</p>
        <ul style="text-align:left;">
          <li>➕ Agregar palabras manualmente abajo</li>
          <li>🤖 Usar el chatbot para aprender nuevas palabras</li>
          <li>📝 Traducir palabras del español al guaraní</li>
        </ul>
      </div>
    {% endfor %}
  </div>

  <!-- Pagination Controls -->
  {% if pagination.total_pages > 1 %}
  <div style="max-width:1200px;margin:20px auto;padding:0 20px;text-align:center;">
    <div class="pagination-container">
      <!-- Previous button -->
      {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_page }}" class="pagination-btn pagination-prev" aria-label="Página anterior">
          « Anterior
        </a>
      {% else %}
        <span class="pagination-btn pagination-disabled">« Anterior</span>
      {% endif %}

      <!-- Page numbers -->
      <div class="pagination-pages">
        {% for page_num in pagination.page_range %}
          {% if page_num == pagination.current_page %}
            <span class="pagination-page pagination-current">{{ page_num }}</span>
          {% else %}
            <a href="?page={{ page_num }}" class="pagination-page" aria-label="Página {{ page_num }}">{{ page_num }}</a>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Next button -->
      {% if pagination.has_next %}
        <a href="?page={{ pagination.next_page }}" class="pagination-btn pagination-next" aria-label="Página siguiente">
          Siguiente »
        </a>
      {% else %}
        <span class="pagination-btn pagination-disabled">Siguiente »</span>
      {% endif %}
    </div>

    <!-- Page info -->
    <div class="pagination-info">
      <p>
        Mostrando {{ pagination.per_page }} palabras por página |
        Página {{ pagination.current_page }} de {{ pagination.total_pages }} |
        Total: {{ pagination.total_entries }} palabras
      </p>
    </div>
  </div>
  {% endif %}

  <!-- Enhanced Translation Input Section -->
  <div style="max-width:900px;margin:20px auto;padding:0 20px;">
    <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;border-radius:12px;color:white;">
      <h3 style="margin:0 0 12px;">🌟 Traductor Inteligente</h3>
      <p style="margin:0 0 16px;opacity:0.9;">Escribe una palabra o frase en español y obtén la traducción automática al guaraní</p>

      <div style="display:flex;gap:12px;margin-bottom:16px;">
        <input id="translate-input" type="text" placeholder="Ej: hola, gracias, familia, escuela..."
               style="flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;"
               onkeypress="if(event.key==='Enter') translateAndAdd()">
        <button class="qx-btn" onclick="translateAndAdd()" style="background:white;color:#667eea;font-weight:600;">
          🚀 Traducir y Agregar
        </button>
      </div>

      <div id="translation-result" style="display:none;background:rgba(255,255,255,0.1);padding:12px;border-radius:8px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <div>
            <strong>Español:</strong> <span id="original-text"></span>
          </div>
          <div style="font-size:1.5em;">→</div>
          <div>
            <strong>Guaraní:</strong> <span id="translated-text"></span>
          </div>
          <button onclick="confirmAddToGlossary()" class="qx-btn" style="background:#4caf50;color:white;">
            ✅ Agregar al Glosario
          </button>
          <button onclick="hideTranslationResult()" class="qx-btn qx-outline" style="color:white;border-color:white;">
            ❌ Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manual Addition Section (Simplified) -->
  <div style="max-width:760px;margin:14px auto 0;display:flex;gap:10px;flex-wrap:wrap;">
    <input id="manual-es" type="text" placeholder="Español (manual)">
    <input id="manual-gn" type="text" placeholder="Guaraní (manual)">
    <button class="qx-btn qx-outline" onclick="addManual()">➕ Agregar Manual</button>
  </div>
{% endblock %}

<style>
/* Enhanced Glossary Styles */
.enhanced-flash {
  position: relative;
}

.category-badge {
  font-size: 0.75em;
  padding: 2px 6px;
  border-radius: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.category-badge[data-category="saludo"] { background: #e3f2fd; color: #1976d2; }
.category-badge[data-category="familia"] { background: #fce4ec; color: #c2185b; }
.category-badge[data-category="escuela"] { background: #e8f5e8; color: #388e3c; }
.category-badge[data-category="comida"] { background: #fff3e0; color: #f57c00; }
.category-badge[data-category="lugares"] { background: #f3e5f5; color: #7b1fa2; }
.category-badge[data-category="numeros"] { background: #e0f2f1; color: #00796b; }
.category-badge[data-category="colores"] { background: #fce4ec; color: #e91e63; }
.category-badge[data-category="general"] { background: #f5f5f5; color: #616161; }

.difficulty-badge {
  font-size: 0.7em;
  padding: 2px 6px;
  border-radius: 12px;
  font-weight: 600;
}

.difficulty-beginner { background: #c8e6c9; color: #2e7d32; }
.difficulty-intermediate { background: #fff9c4; color: #fbc02d; }
.difficulty-advanced { background: #ffcdd2; color: #c62828; }

.favorite-indicator {
  position: absolute;
  top: 8px;
  right: 8px;
  font-size: 1.2em;
  z-index: 10;
}

.mastery-indicator {
  margin: 8px 0;
}

.mastery-bar {
  width: 100%;
  height: 6px;
  background: #e0e0e0;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 4px;
}

.mastery-fill {
  height: 100%;
  background: linear-gradient(90deg, #4caf50, #8bc34a);
  transition: width 0.3s ease;
}

.mastery-text {
  font-size: 0.8em;
  color: #4caf50;
  font-weight: 600;
}

.usage-examples {
  background: #f8f9fa;
  padding: 8px;
  border-radius: 6px;
  margin: 8px 0;
  font-size: 0.9em;
}

.usage-examples ul {
  margin: 4px 0;
  padding-left: 20px;
}

.usage-examples li {
  margin: 2px 0;
  color: #495057;
}

.tags-container {
  margin: 8px 0;
}

.tag-badge {
  display: inline-block;
  background: #e3f2fd;
  color: #1976d2;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75em;
  margin: 2px 4px 2px 0;
  font-weight: 500;
}

/* Enhanced flashcard styling */
.flash-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.flash {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  cursor: pointer;
}

.flash:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.flash-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transition: transform 0.6s;
  transform-style: preserve-3d;
}

.flash.flipped .flash-inner {
  transform: rotateY(180deg);
}

.face {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 12px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.face-front {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.face-back {
  background: white;
  color: #333;
  transform: rotateY(180deg);
}

.face .tag {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(255,255,255,0.2);
  color: white;
  padding: 4px 8px;
  border-radius: 20px;
  font-size: 0.8em;
  font-weight: 600;
  backdrop-filter: blur(10px);
}

.face-back .tag {
  background: #e3f2fd;
  color: #1976d2;
}

.face .word {
  font-size: 1.5em;
  font-weight: bold;
  text-align: center;
  margin: 20px 0;
  line-height: 1.2;
}

.face-back .word {
  color: #2c3e50;
}

.face .sub {
  font-size: 0.9em;
  opacity: 0.8;
  text-align: center;
  margin: 8px 0;
  font-style: italic;
}

.face-back .sub {
  color: #6c757d;
}

.actions {
  display: flex;
  gap: 8px;
  margin-top: auto;
  flex-wrap: wrap;
}

.rec-controls {
  display: flex;
  gap: 6px;
  margin: 8px 0;
  flex-wrap: wrap;
}

.rec-controls .qx-btn {
  font-size: 0.8em;
  padding: 4px 8px;
}

/* Responsive design */
@media (max-width: 768px) {
  .flash-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .face {
    padding: 12px;
  }

  .face .word {
    font-size: 1.3em;
  }
}

/* Filter controls styling */
#glossary-search, #category-filter, #difficulty-filter {
  padding: 8px 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.3s ease;
}

#glossary-search:focus, #category-filter:focus, #difficulty-filter:focus {
  outline: none;
  border-color: #667eea;
}

.qx-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: background-color 0.3s ease;
}

.qx-btn:hover {
  background: #5a67d8;
}

.qx-btn.qx-outline {
  background: transparent;
  border: 2px solid #667eea;
  color: #667eea;
}

.qx-btn.qx-outline:hover {
  background: #667eea;
  color: white;
}

/* Stats styling */
#total-words, #favorites-count, #reviewed-count, #mastered-count {
  font-weight: 600;
  color: #495057;
  background: white;
  padding: 4px 8px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Animation for new cards */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.flash {
  animation: fadeInUp 0.5s ease-out;
}

/* Enhanced Toolbar Styles */
.glossary-toolbar {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

.search-filters-section {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-bottom: 16px;
}

.search-bar {
  display: flex;
  gap: 8px;
  align-items: center;
}

.basic-filters {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

.advanced-search-panel {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 12px;
  border: 1px solid #e9ecef;
}

.advanced-filters {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  align-items: center;
  font-size: 0.9em;
}

.advanced-filters input[type="checkbox"] {
  margin-right: 4px;
}

.advanced-filters label {
  margin-right: 12px;
  font-weight: 500;
  color: #495057;
}

.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: flex-end;
  padding-top: 12px;
  border-top: 1px solid #e9ecef;
}

.study-mode-btn {
  background: linear-gradient(135deg, #28a745, #20c997) !important;
  font-weight: 600;
}

.study-mode-btn:hover {
  background: linear-gradient(135deg, #218838, #1dd1a1) !important;
}

/* Enhanced Stats Styles */
.stats-container {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  border-radius: 10px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border: 1px solid #e9ecef;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-icon {
  font-size: 2em;
  opacity: 0.8;
  min-width: 40px;
  text-align: center;
}

.stat-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.stat-number {
  font-size: 1.8em;
  font-weight: bold;
  color: #2c3e50;
  line-height: 1;
}

.stat-label {
  font-size: 0.9em;
  color: #6c757d;
  margin-top: 2px;
  font-weight: 500;
}

/* Progress Overview Styles */
.progress-overview {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

.progress-overview h3 {
  margin: 0 0 16px 0;
  color: #2c3e50;
  font-size: 1.2em;
}

.progress-charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.chart-container {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 16px;
  border: 1px solid #e9ecef;
}

/* Dark Mode Styles */
.dark-mode {
  background: #1a1a1a !important;
  color: #ffffff !important;
}

.dark-mode .glossary-toolbar,
.dark-mode .stats-container,
.dark-mode .progress-overview {
  background: #2d2d2d !important;
  border-color: #404040 !important;
}

.dark-mode .stat-card {
  background: linear-gradient(135deg, #3d3d3d, #4d4d4d) !important;
}

.dark-mode .stat-number {
  color: #ffffff !important;
}

.dark-mode .stat-label {
  color: #adb5bd !important;
}

.dark-mode .advanced-search-panel {
  background: #3d3d3d !important;
  border-color: #4d4d4d !important;
}

.dark-mode .advanced-filters label {
  color: #adb5bd !important;
}

.dark-mode .chart-container {
  background: #3d3d3d !important;
  border-color: #4d4d4d !important;
}

/* Enhanced Card Styles for Dark Mode */
.dark-mode .flash {
  background: #2d2d2d !important;
  border-color: #404040 !important;
}

.dark-mode .face-back {
  background: #2d2d2d !important;
  color: #ffffff !important;
}

.dark-mode .face-back .word {
  color: #ffffff !important;
}

.dark-mode .face-back .sub {
  color: #adb5bd !important;
}

.dark-mode .usage-examples {
  background: #3d3d3d !important;
  color: #ffffff !important;
}

.dark-mode .usage-examples li {
  color: #adb5bd !important;
}

.dark-mode .tags-container .tag-badge {
  background: #404040 !important;
  color: #ffffff !important;
}

/* Accessibility Improvements */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* Focus indicators for keyboard navigation */
.flash:focus {
  outline: 3px solid #007bff;
  outline-offset: 2px;
}

.qx-btn:focus {
  outline: 2px solid #007bff;
  outline-offset: 2px;
}

select:focus,
input:focus {
  outline: 2px solid #007bff;
  outline-offset: 1px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  .stat-card {
    border: 2px solid #000;
  }

  .flash {
    border: 2px solid #000;
  }

  .qx-btn {
    border-width: 2px;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  .flash {
    animation: none;
  }

  .stat-card {
    transition: none;
  }

  .flash {
    transition: none;
  }

  .mastery-fill {
    transition: none;
  }
}

/* Study Mode Styles */
.study-mode {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.9);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.study-card {
  background: white;
  border-radius: 16px;
  padding: 32px;
  max-width: 500px;
  width: 100%;
  text-align: center;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.study-progress {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin: 20px 0;
}

.study-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #e0e0e0;
  transition: background-color 0.3s ease;
}

.study-dot.active {
  background: #007bff;
}

.study-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 24px;
}

.study-reveal-btn {
  background: #28a745 !important;
  color: white !important;
}

.study-rating {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 16px;
}

.rating-btn {
  padding: 8px 16px;
  border: 2px solid #007bff;
  background: white;
  color: #007bff;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.rating-btn:hover {
  background: #007bff;
  color: white;
}

.rating-btn.correct {
  background: #28a745;
  border-color: #28a745;
  color: white;
}

.rating-btn.incorrect {
  background: #dc3545;
  border-color: #dc3545;
  color: white;
}

/* Enhanced Responsive Design */
@media (max-width: 1024px) {
  .glossary-toolbar {
    padding: 16px;
  }

  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
  }

  .progress-charts {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .basic-filters {
    flex-direction: column;
    align-items: stretch;
  }

  .action-buttons {
    justify-content: center;
  }

  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .stat-card {
    padding: 12px;
  }

  .stat-number {
    font-size: 1.3em;
  }

  .study-card {
    padding: 24px;
    margin: 16px;
  }

  .study-actions {
    flex-direction: column;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }

  .advanced-filters {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .study-rating {
    flex-direction: column;
  }
}

/* Loading Animation */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* Enhanced Animations */
@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.glossary-toolbar {
  animation: slideInUp 0.6s ease-out;
}

.stats-container {
  animation: slideInUp 0.6s ease-out 0.1s both;
}

.flash-grid {
  animation: fadeIn 0.6s ease-out 0.2s both;
}

.flash:nth-child(odd) {
  animation-delay: 0.3s;
}

.flash:nth-child(even) {
  animation-delay: 0.4s;
}

/* Notification Enhancements */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 20px;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  z-index: 1000;
  animation: slideInRight 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  max-width: 400px;
}

.notification.success {
  background: linear-gradient(135deg, #28a745, #20c997);
}

.notification.error {
  background: linear-gradient(135deg, #dc3545, #e74c3c);
}

.notification.warning {
  background: linear-gradient(135deg, #ffc107, #fd7e14);
}

.notification.info {
  background: linear-gradient(135deg, #17a2b8, #007bff);
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}

/* Enhanced Button States */
.qx-btn {
  position: relative;
  overflow: hidden;
}

.qx-btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255,255,255,0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.3s ease, height 0.3s ease;
}

.qx-btn:active::before {
  width: 300px;
  height: 300px;
}

/* Card Hover Effects */
.flash {
  position: relative;
  overflow: hidden;
}

.flash::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.5s ease;
}

.flash:hover::before {
  left: 100%;
}

/* Enhanced Focus Management */
.flash:focus-visible {
  outline: 3px solid #007bff;
  outline-offset: 2px;
}

/* Skip to content link for screen readers */
.skip-link {
  position: absolute;
  top: -40px;
  left: 6px;
  background: #007bff;
  color: white;
  padding: 8px;
  text-decoration: none;
  border-radius: 4px;
  z-index: 1000;
}

.skip-link:focus {
  top: 6px;
}

/* Pagination Styles */
.pagination-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  margin: 20px 0;
  flex-wrap: wrap;
}

.pagination-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: #667eea;
  color: white;
  text-decoration: none;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
  border: none;
  cursor: pointer;
  font-size: 14px;
}

.pagination-btn:hover:not(.pagination-disabled) {
  background: #5a67d8;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.pagination-btn.pagination-disabled {
  background: #e9ecef;
  color: #6c757d;
  cursor: not-allowed;
  opacity: 0.6;
}

.pagination-pages {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  justify-content: center;
}

.pagination-page {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  text-decoration: none;
  color: #495057;
  background: white;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
  font-size: 14px;
}

.pagination-page:hover {
  background: #667eea;
  color: white;
  border-color: #667eea;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.pagination-page.pagination-current {
  background: #667eea;
  color: white;
  border-color: #667eea;
  cursor: default;
}

.pagination-info {
  text-align: center;
  color: #6c757d;
  font-size: 14px;
  margin-top: 8px;
}

.pagination-info p {
  margin: 0;
  font-weight: 500;
}

/* Dark mode pagination styles */
.dark-mode .pagination-page {
  background: #2d2d2d;
  color: #ffffff;
  border-color: #404040;
}

.dark-mode .pagination-page:hover {
  background: #667eea;
  border-color: #667eea;
}

.dark-mode .pagination-page.pagination-current {
  background: #667eea;
  border-color: #667eea;
}

.dark-mode .pagination-info {
  color: #adb5bd;
}

/* Responsive pagination */
@media (max-width: 768px) {
  .pagination-container {
    gap: 8px;
  }

  .pagination-btn {
    padding: 8px 12px;
    font-size: 13px;
  }

  .pagination-pages {
    gap: 2px;
  }

  .pagination-page {
    width: 36px;
    height: 36px;
    font-size: 13px;
  }

  .pagination-info {
    font-size: 13px;
  }
}

@media (max-width: 480px) {
  .pagination-container {
    flex-direction: column;
    gap: 12px;
  }

  .pagination-pages {
    max-width: 100%;
    overflow-x: auto;
    padding: 4px 0;
  }

  .pagination-info {
    font-size: 12px;
  }
}
</style>

{% block extra_js %}
  <script src="{% static 'js/tts.js' %}"></script>
  <script src="{% static 'js/glossary.js' %}"></script>
  <script src="{% static 'js/flashcards.js' %}"></script>

  <script>
  // Enhanced glossary functionality with advanced features
  let showOnlyFavorites = false;
  let currentStudyCards = [];
  let currentStudyIndex = 0;
  let isDarkMode = false;
  let studyStreak = parseInt(localStorage.getItem('studyStreak')) || 0;
  let lastStudyDate = localStorage.getItem('lastStudyDate');

  // Keyboard navigation
  let currentFocusIndex = 0;
  let focusableCards = [];

  function qxFilterGlossary() {
    const searchTerm = document.getElementById('glossary-search').value.toLowerCase();
    const categoryFilter = document.getElementById('category-filter').value;
    const difficultyFilter = document.getElementById('difficulty-filter').value;
    const masteryFilter = document.getElementById('mastery-filter').value;

    // Advanced search options
    const searchEsOnly = document.getElementById('search-es-only').checked;
    const searchGnOnly = document.getElementById('search-gn-only').checked;
    const searchExactMatch = document.getElementById('search-exact-match').checked;

    const cards = document.querySelectorAll('.enhanced-flash');

    cards.forEach(card => {
      const esText = card.dataset.es || '';
      const gnText = card.dataset.gn || '';
      const category = card.dataset.category || '';
      const difficulty = card.dataset.difficulty || '';
      const mastery = parseFloat(card.dataset.mastery) || 0;
      const isFavorite = card.dataset.favorite === 'true';

      // Enhanced search logic
      let matchesSearch = true;
      if (searchTerm) {
        if (searchExactMatch) {
          matchesSearch = esText === searchTerm || gnText === searchTerm;
        } else if (searchEsOnly) {
          matchesSearch = esText.includes(searchTerm);
        } else if (searchGnOnly) {
          matchesSearch = gnText.includes(searchTerm);
        } else {
          matchesSearch = esText.includes(searchTerm) || gnText.includes(searchTerm);
        }
      }

      // Category filter
      const matchesCategory = !categoryFilter || category === categoryFilter;

      // Difficulty filter
      const matchesDifficulty = !difficultyFilter || difficulty === difficultyFilter;

      // Mastery level filter
      let matchesMastery = true;
      if (masteryFilter) {
        switch(masteryFilter) {
          case 'new':
            matchesMastery = mastery === 0;
            break;
          case 'learning':
            matchesMastery = mastery > 0 && mastery < 50;
            break;
          case 'practicing':
            matchesMastery = mastery >= 50 && mastery < 90;
            break;
          case 'mastered':
            matchesMastery = mastery >= 90;
            break;
        }
      }

      // Favorites filter
      const matchesFavorites = !showOnlyFavorites || isFavorite;

      // Show/hide card based on all filters
      if (matchesSearch && matchesCategory && matchesDifficulty && matchesMastery && matchesFavorites) {
        card.style.display = 'block';
        card.setAttribute('aria-hidden', 'false');
      } else {
        card.style.display = 'none';
        card.setAttribute('aria-hidden', 'true');
      }
    });

    updateFocusableCards();
    updateStats();
  }

  function sortGlossary() {
    const sortOrder = document.getElementById('sort-order').value;
    const cards = Array.from(document.querySelectorAll('.enhanced-flash'));
    const container = document.getElementById('flash-grid');

    cards.sort((a, b) => {
      switch(sortOrder) {
        case 'alphabetical-es':
          return (a.dataset.es || '').localeCompare(b.dataset.es || '');
        case 'alphabetical-gn':
          return (a.dataset.gn || '').localeCompare(b.dataset.gn || '');
        case 'mastery':
          return (parseFloat(b.dataset.mastery) || 0) - (parseFloat(a.dataset.mastery) || 0);
        case 'difficulty':
          const difficultyOrder = {beginner: 0, intermediate: 1, advanced: 2};
          return difficultyOrder[b.dataset.difficulty] - difficultyOrder[a.dataset.difficulty];
        case 'recent':
        default:
          return 0; // Keep original order for recent
      }
    });

    // Clear and re-append sorted cards
    cards.forEach(card => container.appendChild(card));
  }

  function toggleAdvancedSearch() {
    const panel = document.getElementById('advanced-search-panel');
    const btn = document.getElementById('advanced-search-btn');

    if (panel.style.display === 'none') {
      panel.style.display = 'block';
      btn.innerHTML = '🔧';
      btn.setAttribute('aria-expanded', 'true');
    } else {
      panel.style.display = 'none';
      btn.innerHTML = '⚙️';
      btn.setAttribute('aria-expanded', 'false');
    }
  }

  function toggleFavorites() {
    showOnlyFavorites = !showOnlyFavorites;
    const btn = document.getElementById('favorites-btn');

    if (showOnlyFavorites) {
      btn.textContent = '❤️ Solo Favoritos';
      btn.classList.remove('qx-outline');
      btn.classList.add('qx-btn');
      btn.setAttribute('aria-pressed', 'true');
    } else {
      btn.textContent = '⭐ Favoritos';
      btn.classList.remove('qx-btn');
      btn.classList.add('qx-outline');
      btn.setAttribute('aria-pressed', 'false');
    }

    qxFilterGlossary();
  }

  function toggleFavorite(entryId) {
    fetch(`/learning/api/glossary/${entryId}/favorite/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const card = document.querySelector(`[onclick*="toggleFavorite(${entryId})"]`).closest('.enhanced-flash');
        const favoriteBtn = card.querySelector('[onclick*="toggleFavorite"]');

        if (data.is_favorite) {
          favoriteBtn.innerHTML = '⭐❤️';
          favoriteBtn.title = 'Quitar de favoritos';
          card.dataset.favorite = 'true';
        } else {
          favoriteBtn.innerHTML = '☆🤍';
          favoriteBtn.title = 'Agregar a favoritos';
          card.dataset.favorite = 'false';
        }

        updateStats();
        showNotification('Estado de favorito actualizado', 'success');
      }
    })
    .catch(error => {
      console.error('Error toggling favorite:', error);
      showNotification('Error al actualizar favorito', 'error');
    });
  }

  function updateStats() {
    const cards = document.querySelectorAll('.enhanced-flash');
    const visibleCards = document.querySelectorAll('.enhanced-flash[aria-hidden="false"]');

    // Basic stats
    document.getElementById('total-words').textContent = cards.length;

    const favorites = document.querySelectorAll('.enhanced-flash[data-favorite="true"]');
    document.getElementById('favorites-count').textContent = favorites.length;

    const reviewed = document.querySelectorAll('.enhanced-flash[data-mastery]');
    document.getElementById('reviewed-count').textContent = reviewed.length;

    const mastered = document.querySelectorAll('.enhanced-flash[data-mastery="100"], .enhanced-flash[data-mastery="1"]');
    document.getElementById('mastered-count').textContent = mastered.length;

    // Advanced stats
    let totalMastery = 0;
    cards.forEach(card => {
      totalMastery += parseFloat(card.dataset.mastery) || 0;
    });
    const avgMastery = cards.length > 0 ? Math.round(totalMastery / cards.length) : 0;
    document.getElementById('avg-mastery').textContent = `${avgMastery}%`;

    // Update study streak
    const today = new Date().toDateString();
    if (lastStudyDate !== today) {
      if (lastStudyDate === new Date(Date.now() - 86400000).toDateString()) {
        studyStreak++;
      } else if (lastStudyDate !== today) {
        studyStreak = 1;
      }
      localStorage.setItem('studyStreak', studyStreak.toString());
      localStorage.setItem('lastStudyDate', today);
      lastStudyDate = today;
    }
    document.getElementById('study-streak').textContent = studyStreak;
  }

  function updateFocusableCards() {
    focusableCards = Array.from(document.querySelectorAll('.enhanced-flash[aria-hidden="false"]'));
    currentFocusIndex = 0;
  }

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Tab' && !e.shiftKey) {
      // Tab navigation through cards
      e.preventDefault();
      if (focusableCards.length > 0) {
        focusableCards[currentFocusIndex].focus();
        currentFocusIndex = (currentFocusIndex + 1) % focusableCards.length;
      }
    } else if (e.key === 'Enter' || e.key === ' ') {
      // Flip card on Enter or Space
      const focusedCard = document.activeElement;
      if (focusedCard && focusedCard.classList.contains('enhanced-flash')) {
        e.preventDefault();
        focusedCard.classList.toggle('flipped');
      }
    } else if (e.key === 'Escape') {
      // Close any open modals or reset focus
      const studyMode = document.querySelector('.study-mode');
      if (studyMode) {
        closeStudyMode();
      }
    }
  });

  // Study Mode Functions
  function startStudyMode() {
    const visibleCards = Array.from(document.querySelectorAll('.enhanced-flash[aria-hidden="false"]'));
    if (visibleCards.length === 0) {
      showNotification('No hay tarjetas visibles para estudiar', 'warning');
      return;
    }

    currentStudyCards = visibleCards.map(card => ({
      id: card.querySelector('[onclick*="toggleFavorite"]').onclick.toString().match(/toggleFavorite\((\d+)\)/)[1],
      spanish: card.dataset.es,
      guarani: card.dataset.gn,
      category: card.dataset.category,
      difficulty: card.dataset.difficulty
    }));

    currentStudyIndex = 0;
    showStudyCard();
  }

  function showStudyCard() {
    if (currentStudyIndex >= currentStudyCards.length) {
      showStudyComplete();
      return;
    }

    const card = currentStudyCards[currentStudyIndex];
    const studyMode = document.createElement('div');
    studyMode.className = 'study-mode';
    studyMode.innerHTML = `
      <div class="study-card" role="dialog" aria-labelledby="study-word" aria-describedby="study-instructions">
        <div class="study-progress">
          ${currentStudyCards.map((_, i) => `<div class="study-dot ${i === currentStudyIndex ? 'active' : ''}"></div>`).join('')}
        </div>
        <h2 id="study-word">${card.guarani}</h2>
        <p id="study-instructions">Presiona "Mostrar" para ver la traducción</p>
        <div class="study-actions">
          <button class="qx-btn study-reveal-btn" onclick="revealStudyCard()">Mostrar Traducción</button>
          <button class="qx-btn qx-outline" onclick="closeStudyMode()">Cerrar</button>
        </div>
        <div id="study-answer" style="display:none; margin-top:20px;">
          <h3>Español: ${card.spanish}</h3>
          <div class="study-rating">
            <button class="rating-btn" onclick="rateStudyCard('easy')">😊 Fácil</button>
            <button class="rating-btn" onclick="rateStudyCard('good')">👍 Bien</button>
            <button class="rating-btn" onclick="rateStudyCard('hard')">😅 Difícil</button>
            <button class="rating-btn" onclick="rateStudyCard('again')">🔄 Otra vez</button>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(studyMode);
    studyMode.focus();

    // Update last study date for streak
    const today = new Date().toDateString();
    localStorage.setItem('lastStudyDate', today);
  }

  function revealStudyCard() {
    const answerDiv = document.getElementById('study-answer');
    const instructions = document.getElementById('study-instructions');

    answerDiv.style.display = 'block';
    instructions.textContent = 'Califica qué tan fácil fue recordar esta palabra:';
  }

  function rateStudyCard(rating) {
    // Update mastery based on rating
    const card = currentStudyCards[currentStudyIndex];
    updateCardMastery(card.id, rating);

    currentStudyIndex++;
    closeStudyMode();
    showStudyCard();
  }

  function updateCardMastery(cardId, rating) {
    const masteryIncrease = {
      'easy': 25,
      'good': 15,
      'hard': 5,
      'again': -10
    };

    const increase = masteryIncrease[rating] || 0;
    // Here you would typically send this to the server
    // For now, we'll just show a notification
    showNotification(`Progreso actualizado: ${increase > 0 ? '+' : ''}${increase}%`, 'success');
  }

  function showStudyComplete() {
    const studyMode = document.createElement('div');
    studyMode.className = 'study-mode';
    studyMode.innerHTML = `
      <div class="study-card">
        <h2>🎉 ¡Sesión de Estudio Completada!</h2>
        <p>Has estudiado ${currentStudyCards.length} palabras.</p>
        <p>Tu racha de estudio: ${++studyStreak} días</p>
        <div class="study-actions">
          <button class="qx-btn" onclick="closeStudyMode()">Cerrar</button>
          <button class="qx-btn qx-outline" onclick="startStudyMode()">Estudiar de Nuevo</button>
        </div>
      </div>
    `;

    document.body.appendChild(studyMode);
    localStorage.setItem('studyStreak', studyStreak.toString());
    updateStats();
  }

  function closeStudyMode() {
    const studyMode = document.querySelector('.study-mode');
    if (studyMode) {
      studyMode.remove();
    }
  }

  // Dark Mode Functions
  function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    const btn = document.getElementById('dark-mode-btn');

    document.body.classList.toggle('dark-mode', isDarkMode);

    if (isDarkMode) {
      btn.innerHTML = '☀️ Claro';
      btn.setAttribute('aria-pressed', 'true');
    } else {
      btn.innerHTML = '🌙 Oscuro';
      btn.setAttribute('aria-pressed', 'false');
    }

    localStorage.setItem('darkMode', isDarkMode.toString());
  }

  // Export/Import Functions
  function exportGlossary() {
    const cards = Array.from(document.querySelectorAll('.enhanced-flash')).map(card => ({
      spanish: card.dataset.es,
      guarani: card.dataset.gn,
      category: card.dataset.category,
      difficulty: card.dataset.difficulty,
      favorite: card.dataset.favorite === 'true',
      mastery: parseFloat(card.dataset.mastery) || 0
    }));

    const dataStr = JSON.stringify(cards, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `glosario-guarani-${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    showNotification('Glosario exportado exitosamente', 'success');
  }

  function importGlossary() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          importGlossaryData(data);
        } catch (error) {
          showNotification('Error al leer el archivo', 'error');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  function importGlossaryData(data) {
    // Show loading
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'notification';
    loadingDiv.innerHTML = '<div class="loading-spinner"></div> Importando datos...';
    document.body.appendChild(loadingDiv);

    // Process import (simplified - would need server-side implementation)
    setTimeout(() => {
      loadingDiv.remove();
      showNotification(`Importados ${data.length} elementos`, 'success');
      // In a real implementation, you'd send this data to the server
    }, 2000);
  }

  // Statistics and Charts
  function showStats() {
    const overview = document.getElementById('progress-overview');
    if (overview.style.display === 'none') {
      overview.style.display = 'block';
      loadCharts();
    } else {
      overview.style.display = 'none';
    }
  }

  function loadCharts() {
    // Simple chart implementation using canvas
    loadMasteryChart();
    loadCategoryChart();
  }

  function loadMasteryChart() {
    const canvas = document.getElementById('mastery-chart');
    const ctx = canvas.getContext('2d');

    const cards = document.querySelectorAll('.enhanced-flash');
    const masteryLevels = {0: 0, 25: 0, 50: 0, 75: 0, 100: 0};

    cards.forEach(card => {
      const mastery = Math.floor((parseFloat(card.dataset.mastery) || 0) / 25) * 25;
      masteryLevels[mastery]++;
    });

    // Simple bar chart
    const width = canvas.width;
    const height = canvas.height;
    const barWidth = width / 6;
    const maxValue = Math.max(...Object.values(masteryLevels));

    ctx.clearRect(0, 0, width, height);

    Object.entries(masteryLevels).forEach(([level, count], index) => {
      const barHeight = (count / maxValue) * (height - 40);
      const x = (index + 1) * barWidth;
      const y = height - barHeight - 20;

      ctx.fillStyle = level == 100 ? '#28a745' : level >= 50 ? '#ffc107' : '#007bff';
      ctx.fillRect(x, y, barWidth - 10, barHeight);

      ctx.fillStyle = '#333';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(`${level}%`, x + (barWidth - 10) / 2, height - 5);
    });
  }

  function loadCategoryChart() {
    const canvas = document.getElementById('category-chart');
    const ctx = canvas.getContext('2d');

    const cards = document.querySelectorAll('.enhanced-flash');
    const categories = {};

    cards.forEach(card => {
      const category = card.dataset.category || 'general';
      categories[category] = (categories[category] || 0) + 1;
    });

    // Simple pie chart
    const width = canvas.width;
    const height = canvas.height;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 3;

    ctx.clearRect(0, 0, width, height);

    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];
    let startAngle = 0;

    Object.entries(categories).forEach(([category, count], index) => {
      const sliceAngle = (count / cards.length) * 2 * Math.PI;

      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
      ctx.closePath();

      ctx.fillStyle = colors[index % colors.length];
      ctx.fill();

      startAngle += sliceAngle;

      // Add legend
      ctx.fillStyle = '#333';
      ctx.font = '12px Arial';
      ctx.fillText(category, 10, 20 + index * 15);
      ctx.fillRect(5, 15 + index * 15, 10, 10);
    });
  }

  // Enhanced notification system
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = message;
    notification.setAttribute('role', 'alert');
    notification.setAttribute('aria-live', 'polite');

    document.body.appendChild(notification);

    // Add to screen reader announcements
    const srNotification = document.createElement('div');
    srNotification.className = 'sr-only';
    srNotification.textContent = `${type}: ${message}`;
    document.body.appendChild(srNotification);

    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => {
        notification.remove();
        srNotification.remove();
      }, 300);
    }, 4000);
  }

  // Initialize dark mode from localStorage
  function initializeDarkMode() {
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode) {
      isDarkMode = true;
      document.body.classList.add('dark-mode');
      const btn = document.getElementById('dark-mode-btn');
      if (btn) btn.innerHTML = '☀️ Claro';
    }
  }

  // Initialize everything on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateStats();
    updateFocusableCards();
    initializeDarkMode();

    // Load charts if stats panel is visible
    const overview = document.getElementById('progress-overview');
    if (overview && overview.style.display !== 'none') {
      loadCharts();
    }

    // Add skip link for accessibility
    const skipLink = document.createElement('a');
    skipLink.href = '#flash-grid';
    skipLink.className = 'skip-link';
    skipLink.textContent = 'Saltar al contenido principal';
    document.body.insertBefore(skipLink, document.body.firstChild);

    // Focus management for better accessibility
    document.addEventListener('focusin', function(e) {
      if (e.target.classList.contains('enhanced-flash')) {
        currentFocusIndex = focusableCards.indexOf(e.target);
      }
    });
  });

  // Translation and glossary integration functions (enhanced)
  let currentTranslation = null;

  function translateAndAdd() {
    const input = document.getElementById('translate-input');
    const text = input.value.trim();

    if (!text) {
      showNotification('Por favor escribe una palabra o frase en español', 'warning');
      return;
    }

    const translateBtn = document.querySelector('[onclick="translateAndAdd()"]');
    const originalText = translateBtn.textContent;
    translateBtn.textContent = '⏳ Traduciendo...';
    translateBtn.disabled = true;
    translateBtn.setAttribute('aria-busy', 'true');

    // Auto-detect direction based on content
    const direction = detectLanguageDirection(text);

    fetch('/learning/api/ai-translate/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({
        text: text,
        direction: direction
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.translation) {
        showTranslationResult(text, data.translation, data.direction);
        currentTranslation = {
          spanish: direction === 'es_to_gn' ? text : data.translation,
          guarani: direction === 'es_to_gn' ? data.translation : text,
          category: detectCategory(direction === 'es_to_gn' ? text : data.translation),
          difficulty: detectDifficulty(direction === 'es_to_gn' ? data.translation : text)
        };
      } else if (data.fallback) {
        // Use fallback text if translation failed
        showTranslationResult(text, data.fallback, 'fallback');
        currentTranslation = {
          spanish: text,
          guarani: data.fallback,
          category: detectCategory(text),
          difficulty: detectDifficulty(data.fallback)
        };
      } else {
        showNotification('No se pudo generar la traducción. Intenta con otra palabra.', 'error');
      }
    })
    .catch(error => {
      console.error('Translation error:', error);
      showNotification('Error de conexión. Verifica tu conexión a internet.', 'error');
    })
    .finally(() => {
      translateBtn.textContent = originalText;
      translateBtn.disabled = false;
      translateBtn.setAttribute('aria-busy', 'false');
    });
  }

  function detectLanguageDirection(text) {
    // Simple detection based on common Guaraní patterns
    const guaraniPatterns = [
      "'", // Guaraní uses glottal stop
      /\b(che|nde|ha'e|iko|hai|porã|maitei|mba'éichapa)\b/i,
      /\b(rohina|rejapo|reime|jajotopata|ikatú)\b/i
    ];

    const hasGuaraniPattern = guaraniPatterns.some(pattern =>
      typeof pattern === 'string' ? pattern === text : pattern.test(text)
    );

    return hasGuaraniPattern ? 'gn_to_es' : 'es_to_gn';
  }

  function showTranslationResult(spanish, guarani) {
    document.getElementById('original-text').textContent = spanish;
    document.getElementById('translated-text').textContent = guarani;
    document.getElementById('translation-result').style.display = 'block';

    document.getElementById('translation-result').scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });
  }

  function hideTranslationResult() {
    document.getElementById('translation-result').style.display = 'none';
    currentTranslation = null;
  }

  function confirmAddToGlossary() {
    if (!currentTranslation) return;

    const confirmBtn = document.querySelector('[onclick="confirmAddToGlossary()"]');
    const originalText = confirmBtn.textContent;
    confirmBtn.textContent = '⏳ Agregando...';
    confirmBtn.disabled = true;
    confirmBtn.setAttribute('aria-busy', 'true');

    fetch('/learning/api/glossary/add-enhanced/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({
        source_text_es: currentTranslation.spanish,
        translated_text_gn: currentTranslation.guarani,
        category: currentTranslation.category,
        difficulty: currentTranslation.difficulty,
        tags: generateTags(currentTranslation.spanish, currentTranslation.guarani),
        usage_examples: generateUsageExamples(currentTranslation.spanish, currentTranslation.guarani)
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(`¡Palabra agregada al glosario!`, 'success');
        hideTranslationResult();
        document.getElementById('translate-input').value = '';
        setTimeout(() => window.location.reload(), 1000);
      } else {
        showNotification('Error al agregar la palabra. Inténtalo de nuevo.', 'error');
      }
    })
    .catch(error => {
      console.error('Add to glossary error:', error);
      showNotification('Error al agregar la palabra.', 'error');
    })
    .finally(() => {
      confirmBtn.textContent = originalText;
      confirmBtn.disabled = false;
      confirmBtn.setAttribute('aria-busy', 'false');
    });
  }

  // Helper functions (same as before but enhanced)
  function detectCategory(spanishText) {
    const text = spanishText.toLowerCase();

    if (/(hola|buenos?|gracias|por favor|perdón|disculpa|adios|hasta)/.test(text)) {
      return 'saludo';
    }
    if (/(familia|padre|madre|hijo|hija|hermano|hermana|tío|tía|primo|abuelo)/.test(text)) {
      return 'familia';
    }
    if (/(escuela|estudiar|libro|leer|escribir|profesor|alumno|clase)/.test(text)) {
      return 'escuela';
    }
    if (/(comer|agua|pan|carne|fruta|verdura|bebida)/.test(text)) {
      return 'comida';
    }
    if (/(casa|ciudad|pueblo|parque|tienda|mercado|lugar)/.test(text)) {
      return 'lugares';
    }
    if (/(uno|dos|tres|número|contar)/.test(text)) {
      return 'numeros';
    }
    if (/(rojo|azul|verde|amarillo|color|blanco|negro)/.test(text)) {
      return 'colores';
    }

    return 'general';
  }

  function detectDifficulty(guaraniText) {
    if (guaraniText.length <= 10 && !guaraniText.includes("'")) {
      return 'beginner';
    } else if (guaraniText.length <= 20) {
      return 'intermediate';
    }
    return 'advanced';
  }

  function generateTags(spanishText, guaraniText) {
    const tags = [];

    if (spanishText.length <= 5) tags.push('palabra básica');
    if (spanishText.length > 10) tags.push('frase común');
    if (/(hola|gracias|agua|comer|casa)/.test(spanishText.toLowerCase())) {
      tags.push('vocabulario esencial');
    }
    if (guaraniText.includes("'")) tags.push('con acento guaraní');

    return tags;
  }

  function generateUsageExamples(spanishText, guaraniText) {
    const examples = [];

    if (spanishText.toLowerCase().includes('hola')) {
      examples.push(`¡${guaraniText}! ¿Mba'éichapa nde réra?`);
      examples.push(`${guaraniText} Juan, ¿moõ guive rejikói?`);
    } else if (spanishText.toLowerCase().includes('familia')) {
      examples.push(`Che ${guaraniText.toLowerCase()} iko porã`);
      examples.push(`¿Ndépa nde ${guaraniText.toLowerCase()}?`);
    } else {
      examples.push(`${guaraniText} ha'e peteĩ mba'e porã`);
      examples.push(`Ajapo ${guaraniText.toLowerCase()} ndive`);
    }

    return examples;
  }

  // Manual add function (enhanced)
  function addManual() {
    const es = document.getElementById("manual-es").value.trim();
    const gn = document.getElementById("manual-gn").value.trim();

    if (!es || !gn) {
      showNotification("Completa Español y Guaraní", "warning");
      return;
    }

    fetch("/learning/api/glossary/add/", {
      method: "POST",
      headers: {"Content-Type":"application/json","X-CSRFToken": getCSRFToken()},
      body: JSON.stringify({
        source_text_es: es,
        translated_text_gn: gn,
        notes: "",
        category: detectCategory(es),
        difficulty: detectDifficulty(gn)
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.id) {
        showNotification("¡Palabra agregada manualmente!", "success");
        document.getElementById("manual-es").value = "";
        document.getElementById("manual-gn").value = "";
        setTimeout(() => window.location.reload(), 1000);
      } else {
        showNotification("Error al agregar la palabra", "error");
      }
    })
    .catch(error => {
      console.error('Manual add error:', error);
      showNotification('Error al agregar la palabra', 'error');
    });
  }

  // CSRF Token helper
  function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
           document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }
  </script>
{% endblock %}
