{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="chatbot-container">
  <div class="chatbot-header">
    <h1>üí¨ Chatbot Guaran√≠</h1>
    <p class="chatbot-subtitle">Practica guaran√≠ conversando con un profesor virtual</p>

    <!-- Conversation Management -->
    <div class="conversation-management">
      <div class="conversation-selector">
        <label for="conversationSelect">Conversaci√≥n:</label>
        <select id="conversationSelect" onchange="loadConversation()">
          <option value="">Nueva conversaci√≥n</option>
        </select>
        <button id="newConversationBtn" onclick="createNewConversation()" title="Nueva conversaci√≥n">
          ‚ûï
        </button>
        <button id="deleteConversationBtn" onclick="deleteConversation()" title="Eliminar conversaci√≥n" style="display: none;">
          üóëÔ∏è
        </button>
      </div>

      <!-- Model Selection -->
      <div class="model-selection">
        <label for="modelSelect">Modelo de IA:</label>
        <select id="modelSelect" onchange="changeModel()">
          <option value="deepseek" selected>DeepSeek Chat (M√°s r√°pido y confiable)</option>
          <option value="llama">Llama 3.2 (Alternativo)</option>
          <option value="gemma">Gemma 2 (Compacto)</option>
          <option value="fallback">Solo respuestas b√°sicas</option>
        </select>
      </div>
    </div>
  </div>

  <div class="chat-interface">
    <div class="chat-messages" id="chatMessages">
      <!-- Welcome message -->
      <div class="message bot-message">
        <div class="message-avatar">
          <span class="avatar-icon">ü§ñ</span>
        </div>
        <div class="message-content">
          <div class="message-bubble">
            <p><strong>¬°Mba'√©ichapa!</strong> Che ha'e profesor de guaran√≠. ¬øMba'√©ichapa nde r√©ra? ¬øMo√µ guive rejik√≥i?</p>
            <p class="message-translation">¬°Hola! Soy tu profesor de guaran√≠. ¬øC√≥mo te llamas? ¬øDe d√≥nde eres?</p>
          </div>
          <div class="message-time">Ahora</div>
        </div>
      </div>
    </div>

    <div class="chat-input-area">
      <div class="input-container">
        <input type="text"
               id="userInput"
               placeholder="Escribe tu mensaje en espa√±ol o guaran√≠..."
               maxlength="200">
        <button id="sendButton" onclick="sendMessage()">
          <span class="send-icon">üì§</span>
        </button>
      </div>
      <div class="chat-controls">
        <button class="control-btn" onclick="clearChat()">
          üóëÔ∏è Limpiar Chat
        </button>
        <button class="control-btn" onclick="speakLastMessage()">
          üîä Escuchar
        </button>
      </div>
    </div>
  </div>

  <div class="chatbot-footer">
    <div class="chatbot-tips">
      <h4>üí° Consejos para practicar:</h4>
      <ul>
        <li>Puedes escribir en espa√±ol o guaran√≠</li>
        <li>El profesor corregir√° tus errores amablemente</li>
        <li>Usa el bot√≥n üîä para escuchar la pronunciaci√≥n</li>
        <li>Practica saludos, presentaciones y conversaciones b√°sicas</li>
      </ul>
    </div>
  </div>
</div>

<script>
let isWaitingForResponse = false;
let currentConversationId = null;

// Initialize chatbot when page loads
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('userInput').focus();
  loadConversations();
});

function sendMessage() {
  const userInput = document.getElementById('userInput');
  const message = userInput.value.trim();

  if (!message || isWaitingForResponse) return;

  // Add user message to chat
  addMessage(message, 'user');

  // Clear input
  userInput.value = '';
  isWaitingForResponse = true;

  // Show typing indicator
  showTypingIndicator();

  // Send to API with selected model and conversation ID
  const selectedModel = document.getElementById('modelSelect').value;
  const requestData = {
    message: message,
    model: selectedModel
  };

  // Include conversation ID if we have one
  if (currentConversationId) {
    requestData.conversation_id = currentConversationId;
  }

  fetch('/learning/api/chatbot/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
    },
    body: JSON.stringify(requestData)
  })
  .then(response => response.json())
  .then(data => {
    // Remove typing indicator
    hideTypingIndicator();

    if (data.success) {
      // Update current conversation ID if this was a new conversation
      if (data.conversation_id && !currentConversationId) {
        currentConversationId = data.conversation_id;
        loadConversations(); // Refresh the conversations list
      }

      // Add bot response
      addBotResponse(data);
    } else {
      addMessage('Lo siento, hubo un error. Por favor intenta de nuevo.', 'bot');
    }

    isWaitingForResponse = false;
  })
  .catch(error => {
    console.error('Error:', error);
    hideTypingIndicator();
    addMessage('Error de conexi√≥n. Por favor verifica tu conexi√≥n a internet.', 'bot');
    isWaitingForResponse = false;
  });
}

function addMessage(text, sender) {
  const messagesContainer = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}-message`;

  const avatar = sender === 'user' ?
    '<span class="avatar-icon">üë§</span>' :
    '<span class="avatar-icon">ü§ñ</span>';

  const messageContent = `
    <div class="message-avatar">${avatar}</div>
    <div class="message-content">
      <div class="message-bubble">
        <p>${escapeHtml(text)}</p>
      </div>
      <div class="message-time">${getCurrentTime()}</div>
    </div>
  `;

  messageDiv.innerHTML = messageContent;
  messagesContainer.appendChild(messageDiv);
  scrollToBottom();
}

function addBotResponse(data) {
  const messagesContainer = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message bot-message';

  const botContent = `
    <div class="message-avatar">
      <span class="avatar-icon">ü§ñ</span>
    </div>
    <div class="message-content">
      <div class="message-bubble">
        <p><strong>${escapeHtml(data.response_guarani)}</strong></p>
        <p class="message-translation">${escapeHtml(data.response_spanish)}</p>
        ${data.explanation ? `<p class="message-explanation">üìù ${escapeHtml(data.explanation)}</p>` : ''}
        ${data.new_words.length > 0 ? `<p class="message-vocabulary">üìö Nuevas palabras: ${data.new_words.map(word => `<span class="vocab-word">${word}</span>`).join(', ')}</p>` : ''}
      </div>
      <div class="message-time">${getCurrentTime()}</div>
    </div>
  `;

  messageDiv.innerHTML = botContent;
  messagesContainer.appendChild(messageDiv);
  scrollToBottom();
}

function showTypingIndicator() {
  const messagesContainer = document.getElementById('chatMessages');
  const typingDiv = document.createElement('div');
  typingDiv.className = 'message bot-message typing-indicator';
  typingDiv.id = 'typingIndicator';

  typingDiv.innerHTML = `
    <div class="message-avatar">
      <span class="avatar-icon">ü§ñ</span>
    </div>
    <div class="message-content">
      <div class="message-bubble">
        <div class="typing-dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
  `;

  messagesContainer.appendChild(typingDiv);
  scrollToBottom();
}

function hideTypingIndicator() {
  const typingIndicator = document.getElementById('typingIndicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}

function clearChat() {
  document.getElementById('chatMessages').innerHTML = '';
  // Add welcome message back
  addMessage('¬°Mba\'√©ichapa! Che ha\'e profesor de guaran√≠. ¬øMba\'√©ichapa nde r√©ra? ¬øMo√µ guive rejik√≥i?', 'bot');
}

function speakLastMessage() {
  // This would integrate with the TTS system
  const lastBotMessage = document.querySelector('.bot-message:last-child .message-bubble p:first-child');
  if (lastBotMessage) {
    const text = lastBotMessage.textContent;
    window.open(`/learning/api/tts/?text=${encodeURIComponent(text)}&lang=gn`, '_blank');
  }
}

function scrollToBottom() {
  const messagesContainer = document.getElementById('chatMessages');
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getCurrentTime() {
  const now = new Date();
  return now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Enter key support
document.getElementById('userInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    sendMessage();
  }
});

// Auto-focus input
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('userInput').focus();
});

  // Model change handler
function changeModel() {
  const modelSelect = document.getElementById('modelSelect');
  const selectedModel = modelSelect.value;

  // Update welcome message based on model
  const welcomeMessages = {
    'deepseek': '¬°Mba\'√©ichapa! Che hai profesor de guaran√≠ con DeepSeek. ¬øMba\'√©ichapa nde r√©ra?',
    'llama': '¬°Mba\'√©ichapa! Che ha\'e profesor de guaran√≠. ¬øMba\'√©ichapa nde r√©ra? ¬øMo√µ guive rejik√≥i?',
    'gemma': '¬°Mba\'√©ichapa! Soy tu profesor de guaran√≠ con IA r√°pida. ¬øC√≥mo te llamas?',
    'fallback': '¬°Mba\'√©ichapa! Che hai profesor de guaran√≠. ¬øMo√µ guive rejik√≥i?'
  };

  // Update the welcome message in the chat
  const welcomeMessage = welcomeMessages[selectedModel] || welcomeMessages['deepseek'];
  const chatMessages = document.getElementById('chatMessages');
  const firstMessage = chatMessages.querySelector('.bot-message .message-bubble p:first-child');
  if (firstMessage) {
    firstMessage.innerHTML = `<strong>${welcomeMessage.split('.')[0]}</strong>`;
  }

  console.log('Model changed to:', selectedModel);
}

// Conversation management functions
function loadConversations() {
  fetch('/learning/api/chatbot/conversations/')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const conversationSelect = document.getElementById('conversationSelect');
        conversationSelect.innerHTML = '<option value="">Nueva conversaci√≥n</option>';

        data.conversations.forEach(conv => {
          const option = document.createElement('option');
          option.value = conv.id;
          option.textContent = `${conv.title} (${conv.message_count} mensajes)`;
          conversationSelect.appendChild(option);
        });
      }
    })
    .catch(error => {
      console.error('Error loading conversations:', error);
    });
}

function createNewConversation() {
  fetch('/learning/api/chatbot/conversations/new/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
    },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      currentConversationId = data.conversation_id;
      loadConversations(); // Refresh the list

      // Clear chat and start fresh
      clearChat();

      // Show success message
      showNotification('Nueva conversaci√≥n creada', 'success');
    } else {
      showNotification('Error al crear conversaci√≥n', 'error');
    }
  })
  .catch(error => {
    console.error('Error creating conversation:', error);
    showNotification('Error al crear conversaci√≥n', 'error');
  });
}

function loadConversation() {
  const conversationSelect = document.getElementById('conversationSelect');
  const selectedValue = conversationSelect.value;

  if (!selectedValue) {
    // New conversation
    currentConversationId = null;
    clearChat();
    document.getElementById('deleteConversationBtn').style.display = 'none';
    return;
  }

  // Load existing conversation
  currentConversationId = selectedValue;
  document.getElementById('deleteConversationBtn').style.display = 'inline-block';

  fetch(`/learning/api/chatbot/conversations/${currentConversationId}/`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Clear current chat
        document.getElementById('chatMessages').innerHTML = '';

        // Add all messages from the conversation
        data.messages.forEach(msg => {
          if (msg.user_message) {
            addMessage(msg.user_message, 'user');
          }

          if (msg.bot_response_guarani) {
            addBotResponse({
              response_guarani: msg.bot_response_guarani,
              response_spanish: msg.bot_response_spanish,
              explanation: msg.explanation,
              new_words: msg.new_words
            });
          }
        });

        // Scroll to bottom
        scrollToBottom();
      } else {
        showNotification('Error al cargar conversaci√≥n', 'error');
      }
    })
    .catch(error => {
      console.error('Error loading conversation:', error);
      showNotification('Error al cargar conversaci√≥n', 'error');
    });
}

function deleteConversation() {
  if (!currentConversationId) return;

  if (!confirm('¬øEst√°s seguro de que quieres eliminar esta conversaci√≥n? Esta acci√≥n no se puede deshacer.')) {
    return;
  }

  fetch(`/learning/api/chatbot/conversations/${currentConversationId}/delete/`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      currentConversationId = null;
      loadConversations(); // Refresh the list
      clearChat(); // Clear the chat
      document.getElementById('deleteConversationBtn').style.display = 'none';
      showNotification('Conversaci√≥n eliminada', 'success');
    } else {
      showNotification('Error al eliminar conversaci√≥n', 'error');
    }
  })
  .catch(error => {
    console.error('Error deleting conversation:', error);
    showNotification('Error al eliminar conversaci√≥n', 'error');
  });
}

function showNotification(message, type) {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;

  // Add styles for notification
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideInRight 0.3s ease-out;
    ${type === 'success' ? 'background: #22c55e;' : 'background: #ef4444;'}
  `;

  document.body.appendChild(notification);

  // Remove notification after 3 seconds
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-out';
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

// Add CSS animations for notifications
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);
</script>

<style>
.chatbot-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.chatbot-header {
  text-align: center;
  margin-bottom: 30px;
}

.chatbot-header h1 {
  color: var(--primary-color);
  margin-bottom: 8px;
}

.chatbot-subtitle {
  color: var(--text-secondary);
  font-size: 1.1em;
}

.chat-interface {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
  overflow: hidden;
}

:root[data-theme="dark"] .chat-interface {
  background: var(--card);
  border: 1px solid rgba(255,255,255,0.12);
}

.chat-messages {
  height: 400px;
  overflow-y: auto;
  padding: 20px;
  background: #f8f9fa;
}

:root[data-theme="dark"] .chat-messages {
  background: var(--surface);
}

.message {
  display: flex;
  margin-bottom: 20px;
  animation: slideIn 0.3s ease-out;
}

.message-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  font-size: 1.2em;
  flex-shrink: 0;
}

.user-message .message-avatar {
  background: var(--primary-color);
  color: white;
  margin-left: 12px;
  margin-right: 0;
  order: 2;
}

.bot-message .message-avatar {
  background: var(--accent-color);
  color: white;
}

.message-content {
  flex: 1;
  max-width: calc(100% - 52px);
}

.user-message .message-content {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}

.message-bubble {
  background: white;
  padding: 12px 16px;
  border-radius: 18px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  max-width: 80%;
  word-wrap: break-word;
  color: #1f2937; /* Dark text for better contrast */
}

:root[data-theme="dark"] .message-bubble {
  background: var(--card);
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.user-message .message-bubble {
  background: var(--primary-color);
  color: white;
}

.message-translation {
  font-size: 0.9em;
  color: var(--text-secondary);
  margin-top: 4px;
  font-style: italic;
}

.message-explanation {
  font-size: 0.85em;
  color: var(--accent-color);
  margin-top: 6px;
  background: rgba(76, 175, 80, 0.1);
  padding: 6px 10px;
  border-radius: 8px;
}

.message-vocabulary {
  font-size: 0.85em;
  margin-top: 6px;
}

.vocab-word {
  background: var(--secondary-color);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  margin: 0 2px;
}

.message-time {
  font-size: 0.75em;
  color: var(--text-secondary);
  margin-top: 4px;
}

.typing-indicator .message-bubble {
  display: flex;
  align-items: center;
}

.typing-dots {
  display: flex;
  gap: 4px;
}

.typing-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-secondary);
  animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

.chat-input-area {
  padding: 20px;
  background: white;
  border-top: 1px solid var(--border-color);
}

:root[data-theme="dark"] .chat-input-area {
  background: var(--card);
  border-top-color: rgba(255,255,255,0.12);
}

.input-container {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

#userInput {
  flex: 1;
  padding: 12px 16px;
  border: 2px solid var(--border-color);
  border-radius: 25px;
  font-size: 1em;
  outline: none;
  transition: border-color 0.3s ease;
}

#userInput:focus {
  border-color: var(--primary-color);
}

#sendButton {
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.3s ease;
}

#sendButton:hover {
  background: #1565c0;
}

#sendButton:disabled {
  background: var(--text-secondary);
  cursor: not-allowed;
}

.chat-controls {
  display: flex;
  gap: 8px;
}

.control-btn {
  background: var(--secondary-color);
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.9em;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.control-btn:hover {
  background: #616161;
}

.chatbot-footer {
  margin-top: 30px;
  text-align: center;
}

.chatbot-tips {
  background: rgba(255, 193, 7, 0.1);
  padding: 20px;
  border-radius: 8px;
  border-left: 4px solid #ffc107;
}

.chatbot-tips h4 {
  margin-bottom: 12px;
  color: var(--accent-color);
}

.chatbot-tips ul {
  text-align: left;
  max-width: 400px;
  margin: 0 auto;
}

.chatbot-tips li {
  margin-bottom: 6px;
  color: var(--text-secondary);
}

/* Conversation Management Styling */
.conversation-management {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-bottom: 20px;
}

.conversation-selector {
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
}

.conversation-selector label {
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
  white-space: nowrap;
}

#conversationSelect {
  padding: 8px 12px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  background: var(--card);
  color: var(--text);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 200px;
}

#conversationSelect:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
}

#conversationSelect:hover {
  border-color: var(--primary-color);
}

:root[data-theme="dark"] #conversationSelect {
  background: var(--surface);
  border-color: rgba(255,255,255,0.12);
}

:root[data-theme="dark"] #conversationSelect option {
  background: var(--surface);
  color: var(--text);
}

.conversation-selector button {
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 8px;
  width: 40px;
  height: 40px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.conversation-selector button:hover {
  background: #1565c0;
  transform: scale(1.05);
}

.conversation-selector button:disabled {
  background: var(--text-secondary);
  cursor: not-allowed;
  transform: none;
}

#deleteConversationBtn {
  background: #dc2626;
}

#deleteConversationBtn:hover {
  background: #b91c1c;
}

/* Model Selection Styling */
.model-selection {
  margin-top: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: center;
}

.model-selection label {
  font-weight: 600;
  color: var(--text);
  font-size: 14px;
}

#modelSelect {
  padding: 8px 12px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  background: var(--card);
  color: var(--text);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 200px;
}

#modelSelect:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
}

#modelSelect:hover {
  border-color: var(--primary-color);
}

:root[data-theme="dark"] #modelSelect {
  background: var(--surface);
  border-color: rgba(255,255,255,0.12);
}

:root[data-theme="dark"] #modelSelect option {
  background: var(--surface);
  color: var(--text);
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}

/* Scrollbar styling */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Responsive design */
@media (max-width: 768px) {
  .chatbot-container {
    margin: 10px;
    padding: 15px;
  }

  .chat-messages {
    height: 300px;
  }

  .message-bubble {
    max-width: 90%;
  }

  .input-container {
    flex-direction: column;
  }

  #sendButton {
    align-self: center;
  }
}
</style>

{% endblock %}
